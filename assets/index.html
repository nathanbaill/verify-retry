<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Login with Twilio Verify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/16.0.11/css/intlTelInput.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/16.0.11/js/intlTelInput.min.js"></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
      integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="container">
      <h2>Twilio Verify</h2>
      <p>
        This example shows how to use
        <a href="https://twilio.com/docs/verify/api">Twilio Verify</a>
        and Twilio functions for serverless user verification, including best
        practices for SMS retry logic with Voice fallback.
      </p>
      <p></p>
      <div class="content">
        <form id="login">
          <div class="form-group phone-input">
            <p>Enter your phone number:</p>
            <input type="tel" id="phone_number" class="form-control" />
          </div>
          <div class="form-group">
            <input type="submit" class="btn btn-primary" value="Verify" />
          </div>
        </form>
        <span id="form-error" class="text-danger"></span>
      </div>
      <div class="modal" id="verification_modal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <div class="row">
                <div class="col-lg-12">
                  <div class="result-message"></div>
                  <div>
                    <form id="verification" class="input-group input-group-lg">
                      <input
                        type="text"
                        class="form-control input-lg"
                        id="verification_code"
                        placeholder="Enter the token sent to your device"
                        required
                      />
                      <span class="input-group-btn">
                        <button class="btn btn-primary btn-lg" type="submit">
                          Verify
                        </button>
                      </span>
                    </form>
                    <button
                      type="button"
                      id="retry-counter"
                      class="btn btn-link btn-block disabled"
                    ></button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
    </div>
    <!-- /.container -->
    <!-- EDIT_CODE_V2 -->
  </body>
  <script>
    // Handle international prefixes, format phone input field
    // Uses intl-tel-input library
    const phoneInputField = document.querySelector("#phone_number");
    const phoneInput = window.intlTelInput(phoneInputField, {
      // https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
      preferredCountries: ["us", "gb", "de", "co", "jp", "sg"],
      utilsScript:
        "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/16.0.11/js/utils.js",
    });

    function showVerificationStatus(alertType, message) {
      var content = $(".result-message");
      content.empty();
      content.append(
        $("<div>")
          .addClass(`alert alert-${alertType}`)
          .attr("role", "alert")
          .text(message)
      );
    }

    function showVerificationStartError(error) {
      var content = $("#form-error");
      content.empty();
      content.append(`Error: ${error}`);
    }

    function startCountdown() {
      let counter = $("#retry-counter");
      counter.addClass("disabled");

      let timer = function (x) {
        if (x === 0) {
          counter.html("<strong>Resend token</strong>").removeClass("disabled");
          return;
        }

        counter.html(`Resend token in <strong>` + x + ` seconds</strong>`);
        return setTimeout(() => {
          timer(--x);
        }, 1000);
      };

      timer(30);
    }

    var to;

    $("#retry-counter").submit(function (event) {
      // send code again
    });

    function sendVerificationToken(event) {
      event.preventDefault();

      const channel = "sms";
      to = phoneInput.getNumber();

      const data = new URLSearchParams();
      data.append("channel", channel);
      data.append("to", to);

      fetch("./start-verify", {
        method: "POST",
        body: data,
      })
        .then((response) => response.json())
        .then((json) => {
          if (json.success) {
            hidePhoneNumberInput();
            document.getElementById("otp").style.display = "flex";
            startCountdown();
            console.log("Successfully sent token.");
          } else {
            logError(json.error.message + ` ` + json.error.moreInfo);
          }
        })
        .catch((error) => {
          logError(error);
        });
    }

    function logError(error) {
      console.error(error);
      document.getElementById("status").textContent = error;
    }

    function verify(event) {
      event.preventDefault();

      const data = new URLSearchParams();
      data.append("to", to);
      data.append("code", document.getElementById("code").value);

      var tags = document.querySelectorAll("input[name=tags]:checked");
      tags.forEach((tag) => data.append("tags", tag.value));

      fetch("./check-verify", {
        method: "POST",
        body: data,
      })
        .then((response) => response.json())
        .then((json) => {
          if (json.success) {
            hideOtpInput();
            document.getElementById("otp").style.display = "none";
            document.getElementById("status").textContent =
              "Successfully subscribed to updates.";
          } else {
            logError(json.error);
          }
        })
        .catch((error) => {
          logError(error);
        });
    }

    $("#verification").submit(function (event) {
      event.preventDefault();
      const code = $("#verification_code").val();

      // Twilio functions do not accept multipart/form-data
      const data = new URLSearchParams();
      data.append("to", to);
      data.append("verification_code", code);

      fetch("./check-verify", {
        method: "POST",
        body: data,
      })
        .then((response) => response.json())
        .then((json) => {
          if (json.success) {
            showVerificationStatus("success", json.message);
            $("#verification_code").val("");
          } else {
            showVerificationStatus("danger", json.message);
            $("#verification_code").val("");
          }
        })
        .catch((err) => {
          console.log(err);
          showVerificationStatus("danger", "Something went wrong!");
          $("#verification_code").val("");
        });
    });
  </script>
</html>
